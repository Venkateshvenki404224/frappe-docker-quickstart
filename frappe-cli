#!/bin/bash
#
# Frappe CLI - Interactive Command Line Interface
# Purpose: Interactive menu-driven tool for managing Frappe environment
# Usage: ./frappe-cli [command]
#

set -e

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Source library files
source scripts/lib/colors.sh
source scripts/lib/utils.sh
source scripts/lib/validators.sh

# Get compose command
COMPOSE_CMD=$(get_compose_cmd)

# Display ASCII header
display_header() {
    clear
    echo -e "${COLOR_CYAN}"
    cat << "EOF"
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║   ███████╗██████╗  █████╗ ██████╗ ██████╗ ███████╗       ║
║   ██╔════╝██╔══██╗██╔══██╗██╔══██╗██╔══██╗██╔════╝       ║
║   █████╗  ██████╔╝███████║██████╔╝██████╔╝█████╗         ║
║   ██╔══╝  ██╔══██╗██╔══██║██╔═══╝ ██╔═══╝ ██╔══╝         ║
║   ██║     ██║  ██║██║  ██║██║     ██║     ███████╗       ║
║   ╚═╝     ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚═╝     ╚══════╝       ║
║                                                           ║
║              Interactive Management CLI                  ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
EOF
    echo -e "${COLOR_RESET}"
}

# Display current status
display_status() {
    echo ""
    header "Current Status:"
    echo ""

    # Load environment
    if [ -f .env ]; then
        load_env .env
        SITE_NAME=${SITE_NAME:-frontend}
        PORT=${PORT:-8080}
        PRESET=${PRESET:-unknown}
    else
        SITE_NAME="Not configured"
        PORT="Not configured"
        PRESET="unknown"
    fi

    # Check if services are running
    if ${COMPOSE_CMD} ps --services --filter "status=running" &>/dev/null; then
        RUNNING_COUNT=$(${COMPOSE_CMD} ps --services --filter "status=running" 2>/dev/null | wc -l)
        TOTAL_COUNT=$(${COMPOSE_CMD} ps --services 2>/dev/null | wc -l)

        if [ $RUNNING_COUNT -gt 0 ]; then
            STATUS="${COLOR_GREEN}Running${COLOR_RESET} (${RUNNING_COUNT}/${TOTAL_COUNT} services)"
        else
            STATUS="${COLOR_RED}Stopped${COLOR_RESET}"
        fi
    else
        STATUS="${COLOR_YELLOW}Not started${COLOR_RESET}"
    fi

    echo "  Site Name:  ${COLOR_BOLD}${SITE_NAME}${COLOR_RESET}"
    echo "  Port:       ${COLOR_BOLD}${PORT}${COLOR_RESET}"
    echo "  Preset:     ${COLOR_BOLD}${PRESET}${COLOR_RESET}"
    echo "  Status:     ${STATUS}"
    echo ""
    separator 60
}

# Display menu
display_menu() {
    echo ""
    header "Available Commands:"
    echo ""
    echo "  ${COLOR_BOLD}1.${COLOR_RESET}  start          Start all services"
    echo "  ${COLOR_BOLD}2.${COLOR_RESET}  stop           Stop all services"
    echo "  ${COLOR_BOLD}3.${COLOR_RESET}  restart        Restart services"
    echo "  ${COLOR_BOLD}4.${COLOR_RESET}  status         Show detailed service status"
    echo "  ${COLOR_BOLD}5.${COLOR_RESET}  logs           Stream logs (all or specific service)"
    echo "  ${COLOR_BOLD}6.${COLOR_RESET}  shell          Open bash shell in backend container"
    echo "  ${COLOR_BOLD}7.${COLOR_RESET}  bench          Run bench commands directly"
    echo "  ${COLOR_BOLD}8.${COLOR_RESET}  apps           Manage apps (view/add/remove)"
    echo "  ${COLOR_BOLD}9.${COLOR_RESET}  backup         Create backup"
    echo "  ${COLOR_BOLD}10.${COLOR_RESET} restore        Restore from backup"
    echo "  ${COLOR_BOLD}11.${COLOR_RESET} domain         Setup public domain"
    echo "  ${COLOR_BOLD}12.${COLOR_RESET} update         Pull latest changes & rebuild"
    echo "  ${COLOR_BOLD}13.${COLOR_RESET} clean          Remove all data (with backup prompt)"
    echo "  ${COLOR_BOLD}14.${COLOR_RESET} config         Show configuration"
    echo "  ${COLOR_BOLD}15.${COLOR_RESET} help           Show help"
    echo "  ${COLOR_BOLD}q.${COLOR_RESET}  quit           Exit CLI"
    echo ""
    separator 60
}

# Command: start
cmd_start() {
    step "Starting services..."
    ${COMPOSE_CMD} up -d
    success "Services started"
    echo ""
    info "Access your site at: http://localhost:${PORT}"
}

# Command: stop
cmd_stop() {
    step "Stopping services..."
    ${COMPOSE_CMD} stop
    success "Services stopped"
}

# Command: restart
cmd_restart() {
    step "Restarting services..."
    ${COMPOSE_CMD} restart
    success "Services restarted"
}

# Command: status
cmd_status() {
    step "Service Status:"
    echo ""
    ${COMPOSE_CMD} ps
    echo ""

    # Check health if possible
    if ${COMPOSE_CMD} ps --format json &>/dev/null; then
        info "For detailed health: ${COMPOSE_CMD} ps --format json | jq"
    fi
}

# Command: logs
cmd_logs() {
    echo ""
    info "Available services:"
    ${COMPOSE_CMD} ps --services
    echo ""

    read -p "Enter service name (or press Enter for all): " service

    if [ -z "$service" ]; then
        info "Streaming all logs (Ctrl+C to stop)..."
        echo ""
        ${COMPOSE_CMD} logs -f
    else
        info "Streaming logs for ${service} (Ctrl+C to stop)..."
        echo ""
        ${COMPOSE_CMD} logs -f "$service"
    fi
}

# Command: shell
cmd_shell() {
    step "Opening shell in backend container..."
    echo ""
    info "Type 'exit' to return to CLI"
    echo ""
    ${COMPOSE_CMD} exec backend bash
}

# Command: bench
cmd_bench() {
    echo ""
    read -p "Enter bench command: " bench_cmd

    if [ -z "$bench_cmd" ]; then
        error "No command provided"
        return
    fi

    step "Executing: bench ${bench_cmd}"
    echo ""
    ${COMPOSE_CMD} exec backend bench $bench_cmd
}

# Command: apps
cmd_apps() {
    echo ""
    header "App Management"
    echo ""

    # Show installed apps
    step "Installed apps:"
    echo ""
    if [ -f apps.json ]; then
        if command_exists jq; then
            cat apps.json | jq -r '.[] | "  • \(.url | split("/")[-1] | sub(".git$"; "")) (\(.branch))"'
        else
            cat apps.json
        fi
    else
        warning "No apps.json found"
    fi

    echo ""
    info "Note: To add/remove apps, edit apps.json and rebuild"
    info "Then run: ./frappe-cli update"
}

# Command: backup
cmd_backup() {
    if [ -f scripts/backup.sh ]; then
        bash scripts/backup.sh
    else
        warning "Backup script not found"
        info "Manual backup: ${COMPOSE_CMD} exec backend bench backup"
    fi
}

# Command: restore
cmd_restore() {
    if [ -f scripts/restore.sh ]; then
        bash scripts/restore.sh
    else
        warning "Restore script not found"
        info "See documentation for manual restore instructions"
    fi
}

# Command: domain
cmd_domain() {
    if [ -f scripts/domain-setup.sh ]; then
        bash scripts/domain-setup.sh
    else
        warning "Domain setup script not found"
        echo ""
        info "For manual domain setup, see: docs/public-domains.md"
    fi
}

# Command: update
cmd_update() {
    step "Updating Frappe Quickstart..."
    echo ""

    info "Pulling latest changes from git..."
    git pull || warning "Not a git repository or pull failed"

    echo ""
    info "Rebuilding Docker image..."
    ./start.sh --no-browser

    success "Update complete"
}

# Command: clean
cmd_clean() {
    echo ""
    warning "This will remove ALL data including databases and files!"
    echo ""

    if prompt_yes_no "Create backup before cleaning?" "y"; then
        cmd_backup
        echo ""
    fi

    if ! prompt_yes_no "Are you sure you want to remove all data?" "n"; then
        info "Cancelled"
        return
    fi

    step "Stopping services..."
    ${COMPOSE_CMD} down

    step "Removing volumes..."
    ${COMPOSE_CMD} down -v

    step "Removing generated files..."
    rm -f .env apps.json
    rm -rf templates/generated/

    success "Clean complete"
    echo ""
    info "Run ./start.sh to set up again"
}

# Command: config
cmd_config() {
    echo ""
    header "Configuration:"
    echo ""

    if [ -f .env ]; then
        # Display .env without passwords
        cat .env | while IFS= read -r line; do
            if [[ $line == *"PASSWORD"* ]]; then
                key=$(echo "$line" | cut -d'=' -f1)
                echo "  ${key}=********"
            elif [[ ! $line =~ ^[[:space:]]*# ]] && [[ -n $line ]]; then
                echo "  $line"
            fi
        done
    else
        warning "No .env file found"
        info "Run ./start.sh to create configuration"
    fi

    echo ""
}

# Command: help
cmd_help() {
    echo ""
    header "Frappe CLI Help"
    echo ""
    info "This interactive CLI helps you manage your Frappe environment."
    echo ""
    echo "Quick tips:"
    echo "  • Use numbers to select commands from the menu"
    echo "  • Or run directly: ./frappe-cli <command>"
    echo "  • Press Ctrl+C to cancel running operations"
    echo ""
    echo "Documentation:"
    echo "  • Commands:        docs/commands.md"
    echo "  • Troubleshooting: docs/troubleshooting.md"
    echo "  • Public Domains:  docs/public-domains.md"
    echo ""
    info "For detailed help on bench commands:"
    echo "  ./frappe-cli bench help"
    echo ""
}

# Handle command input
handle_input() {
    local input=$1

    case "$input" in
        1|start)
            cmd_start
            ;;
        2|stop)
            cmd_stop
            ;;
        3|restart)
            cmd_restart
            ;;
        4|status)
            cmd_status
            ;;
        5|logs)
            cmd_logs
            ;;
        6|shell)
            cmd_shell
            ;;
        7|bench)
            cmd_bench
            ;;
        8|apps)
            cmd_apps
            ;;
        9|backup)
            cmd_backup
            ;;
        10|restore)
            cmd_restore
            ;;
        11|domain)
            cmd_domain
            ;;
        12|update)
            cmd_update
            ;;
        13|clean)
            cmd_clean
            ;;
        14|config)
            cmd_config
            ;;
        15|help)
            cmd_help
            ;;
        q|quit|exit)
            echo ""
            success "Goodbye!"
            echo ""
            exit 0
            ;;
        *)
            error "Invalid option: $input"
            ;;
    esac
}

# Main function
main() {
    # If command provided as argument, run it directly
    if [ $# -gt 0 ]; then
        handle_input "$1"
        exit 0
    fi

    # Interactive mode
    while true; do
        display_header
        display_status
        display_menu

        echo ""
        read -p "Enter command (number or name): " choice
        echo ""

        handle_input "$choice"

        echo ""
        read -p "Press Enter to continue..."
    done
}

# Run main
main "$@"
